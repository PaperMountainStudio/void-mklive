#!/bin/bash

set -eu

ARCH=$(uname -m)
IMAGES="base enlightenment xfce mate cinnamon gnome kde lxde lxqt"
REPO=
DATE=$(date +%Y%m%d)

help() {
    echo "${0#/*}: [-a arch] [-b base|enlightenment|xfce|mate|cinnamon|gnome|kde|lxde|lxqt] [-r repo]" >&2
}

while getopts "a:b:hr:" opt; do
case $opt in
    a) ARCH="$OPTARG";;
    b) IMAGES="$OPTARG";;
    h) help; exit 0;;
    r) REPO="-r $OPTARG $REPO";;
    *) help; exit 1;;
esac
done
shift $((OPTIND - 1))

deduplicate() {
    printf "%s\n" $@ | sort -u | tr '\n' ' '
}

build_variant() {
    variant="$1"
    shift
    IMG=void-live-${ARCH}-${DATE}-${variant}.iso
    PKGS=()
    SERVICES=()

    export SETUP_TYPE=iso
    . ./setupscripts/main.sh
    setup_variant "$variant"

    PKGSSTR=$(deduplicate "${PKGS[@]}")
    SERVICESSTR=$(deduplicate "${SERVICES[@]}")

    exit 1
    ./mklive.sh -a "$ARCH" -o "$IMG" -p "${PKGSSTR}" -S "${SERVICESSTR}" ${REPO} "$@"
}

if [ ! -x mklive.sh ]; then
    echo mklive.sh not found >&2
    exit 1
fi

for image in $IMAGES; do
    if [ ! -x "setupscripts/variants/$image.sh" ]; then
        echo "Unknown variant $image" >&2
        exit 1
    fi
done

for image in $IMAGES; do
    build_variant "$image" "$@"
done
